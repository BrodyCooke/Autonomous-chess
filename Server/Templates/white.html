<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Game White Player
    </title>
    <style>
        .chess-board { border-spacing: 0; border-collapse: collapse; }
        .chess-board th { padding: .5em; }
        .chess-board th + th { border-bottom: 1px solid #000; }
        .chess-board th:first-child,
        .chess-board td:last-child { border-right: 1px solid #000; }
        .chess-board tr:last-child td { border-bottom: 1px solid; }
        .chess-board th:empty { border: none; }
        .chess-board td { width: 1.5em; height: 1.5em; text-align: center; font-size: 44px; line-height: 0;}
        .chess-board .light { background: #eee; width: 100px; height: 90px; font-size: 44px; }
        .chess-board .dark { background: #aaa; width: 100px; height: 90px; font-size: 44px; }
    </style>
</head>
<body>

<table class="chess-board">
    <tr>
        <th></th>
        <th>a</th>
        <th>b</th>
        <th>c</th>
        <th>d</th>
        <th>e</th>
        <th>f</th>
        <th>g</th>
        <th>h</th>
    <tr>
        <th>8</th>
        <td><button id="57" class="light" onclick="setButton(this)">♜</button></td>
        <td><button id="58" class="dark" onclick="setButton(this)">♞</button></td>
        <td><button id="59" class="light" onclick="setButton(this)">♝</button></td>
        <td><button id="60" class="dark" onclick="setButton(this)">♛</button></td>
        <td><button id="61" class="light" onclick="setButton(this)">♚</button></td>
        <td><button id="62" class="dark" onclick="setButton(this)">♝</button></td>
        <td><button id="63" class="light" onclick="setButton(this)">♞</button></td>
        <td><button id="64" class="dark" onclick="setButton(this)">♜</button></td>
    </tr>
    <tr>
        <th>7</th>
        <td><button id="49" class="dark" onclick="setButton(this)">♟</button></td>
        <td><button id="50" class="light" onclick="setButton(this)">♟</button></td>
        <td><button id="51" class="dark" onclick="setButton(this)">♟</button></td>
        <td><button id="52" class="light" onclick="setButton(this)">♟</button></td>
        <td><button id="53" class="dark" onclick="setButton(this)">♟</button></td>
        <td><button id="54" class="light" onclick="setButton(this)">♟</button></td>
        <td><button id="55" class="dark" onclick="setButton(this)">♟</button></td>
        <td><button id="56" class="light" onclick="setButton(this)">♟</button></td>
    </tr>
    <tr>
        <th>6</th>
        <td><button id="41" class="light" onclick="setButton(this)"></button></td>
        <td><button id="42" class="dark" onclick="setButton(this)"></button></td>
        <td><button id="43" class="light" onclick="setButton(this)"></button></td>
        <td><button id="44" class="dark" onclick="setButton(this)"></button></td>
        <td><button id="45" class="light" onclick="setButton(this)"></button></td>
        <td><button id="46" class="dark" onclick="setButton(this)"></button></td>
        <td><button id="47" class="light" onclick="setButton(this)"></button></td>
        <td><button id="48" class="dark" onclick="setButton(this)"></button></td>
    </tr>
    <tr>
        <th>5</th>
        <td><button id="33" class="dark" onclick="setButton(this)"></button></td>
        <td><button id="34" class="light" onclick="setButton(this)"></button></td>
        <td><button id="35" class="dark" onclick="setButton(this)"></button></td>
        <td><button id="36" class="light" onclick="setButton(this)"></button></td>
        <td><button id="37" class="dark" onclick="setButton(this)"></button></td>
        <td><button id="38" class="light" onclick="setButton(this)"></button></td>
        <td><button id="39" class="dark" onclick="setButton(this)"></button></td>
        <td><button id="40" class="light" onclick="setButton(this)"></button></td>
    </tr>
    <tr>
        <th>4</th>
        <td><button id="25" class="light" onclick="setButton(this)"></button></td>
        <td><button id="26" class="dark" onclick="setButton(this)"></button></td>
        <td><button id="27" class="light" onclick="setButton(this)"></button></td>
        <td><button id="28" class="dark" onclick="setButton(this)"></button></td>
        <td><button id="29" class="light" onclick="setButton(this)"></button></td>
        <td><button id="30" class="dark" onclick="setButton(this)"></button></td>
        <td><button id="31" class="light" onclick="setButton(this)"></button></td>
        <td><button id="32" class="dark" onclick="setButton(this)"></button></td>
    </tr>
    <tr>
        <th>3</th>
        <td><button id="17" class="dark" onclick="setButton(this)"></button></td>
        <td><button id="18" class="light" onclick="setButton(this)"></button></td>
        <td><button id="19" class="dark" onclick="setButton(this)"></button></td>
        <td><button id="20" class="light" onclick="setButton(this)"></button></td>
        <td><button id="21" class="dark" onclick="setButton(this)"></button></td>
        <td><button id="22" class="light" onclick="setButton(this)"></button></td>
        <td><button id="23" class="dark" onclick="setButton(this)"></button></td>
        <td><button id="24" class="light" onclick="setButton(this)"></button></td>
    </tr>
    <tr>
        <th>2</th>
        <td><button id="9" class="light" onclick="setButton(this)">♙</button></td>
        <td><button id="10" class="dark" onclick="setButton(this)">♙</button></td>
        <td><button id="11" class="light" onclick="setButton(this)">♙</button></td>
        <td><button id="12" class="dark" onclick="setButton(this)">♙</button></td>
        <td><button id="13" class="light" onclick="setButton(this)">♙</button></td>
        <td><button id="14" class="dark" onclick="setButton(this)">♙</button></td>
        <td><button id="15" class="light" onclick="setButton(this)">♙</button></td>
        <td><button id="16" class="dark" onclick="setButton(this)">♙</button></td>
    </tr>
    <tr>
        <th>1</th>
        <td><button id="1" class="dark" onclick="setButton(this)">♖</button></td>
        <td><button id="2" class="light" onclick="setButton(this)">♘</button></td>
        <td><button id="3" class="dark" onclick="setButton(this)">♗</button></td>
        <td><button id="4" class="light" onclick="setButton(this)">♕</button></td>
        <td><button id="5" class="dark" onclick="setButton(this)">♔</button></td>
        <td><button id="6" class="light" onclick="setButton(this)">♗</button></td>
        <td><button id="7" class="dark" onclick="setButton(this)">♘</button></td>
        <td><button id="8" class="light" onclick="setButton(this)">♖</button></td>
    </tr>
    
</table>

<form>
    <label style="font-size: 25px;" for="PromotionWhite">Promotion White:</label>
    <select style="font-size: 25px;" id="PromotionWhite">
        <option value="♕">♕</option>
        <option value="♖">♖</option>
        <option value="♗">♗</option>
        <option value="♘">♘</option>
    </select>
    <br><br>
    <label style="font-size: 25px;" for="PromotionBlack">Promotion Black:</label>
    <select style="font-size: 25px;" id="PromotionBlack">
        <option value="♛">♛</option>
        <option value="♜">♜</option>
        <option value="♝">♝</option>
        <option value="♞">♞</option>
    </select>
</form>

<button id="buttonstart" style= "width: 200px; height: 90px; font-size: 44px;" onclick="setButton2(this)">Start</button>
<button id="buttonendgame" style= "width: 200px; height: 90px; font-size: 44px;" onclick="setButton3(this)">End</button>
<button id="buttonTurn" style= "width: 200px; height: 90px; font-size: 30px;" onclick="setButton3(this)">Turn: White</button>
<button id="check_white" style= "width: 200px; height: 90px; font-size: 30px;" onclick="setButton3(this)">Check w: 0</button>
<button id="check_black" style= "width: 200px; height: 90px; font-size: 30px;" onclick="setButton3(this)">Check b: 0</button>


<script>
    var orderCounter = 1; // flag to keep track of order of button presses, goes from 1-> 2 for first click, 2-> 1 for second click
    var c_spacetomove = '#fbe790'; // color for the possible move spaces
    var possiblemoves= []; // Holds button ids, array to hold all possible moves for a piece, index 0 holds the square where the piece to be moved is
    var legal_array // Holds every legal move for the current board state
    var move_flag = 0; // flag that swaps to 1 if player move was in the list of possible moves
    var turn_flag = 0 // 0 for white, 1 for black
    var check_flag_white = 0;
    var check_flag_black = 0;
    var pawn_promoted_flag = 0;
    var promoted_to = '';

    var response;

    // flags for castling
    var white_queenside = 1;
    var white_kingside = 1;
    var black_queenside = 1;
    var black_kingside = 1;
    var castle_flag = 0;


    // Get every legal move for the game start
    legal_array = legalMoves()
    //console.log(legal_array)


    function setButton2(button) {
        if(button.textContent == "Start"){
            //sendMoveToServer("Start");
        }
        orderCounter = 1;
        turn_flag = 0;
        button.textContent = "Count " + (orderCounter);
    }

    function setButton3(button) {
        //sendMoveToServer("End");
    }


    async function setButton(button) {
        start = performance.now()  
        if (turn_flag == 0){
            if (orderCounter == 1) { // what happens when the piece thats clicked is selected to be moved 
                // make sure its not empty
                if(button.textContent == ''){return}
                // check to make sure its the right turn
                if(turn_flag == 0){
                    if(getColor(button.textContent) !== 'white'){return;}
                }
                if(turn_flag == 1){
                    if(getColor(button.textContent) !== 'black'){return;}
                }
                // set color for the selected piece space
                button.style.backgroundColor = '#c8a951';

                // set the possible moves for the clicked piece based on the previously found legal moves
                possiblemoves = []
                possiblemoves.push(parseInt(button.id))
                for(i =0 ; i < legal_array[button.id].length; i++){
                    possiblemoves.push(legal_array[button.id][i]);
                }
                setMoveColor(possiblemoves.slice(1));

            }
            else{ // what happens when the clicked space is where the old piece will be moved
                // check if clicked space is the same as the selected piece
                if(button.id == String(possiblemoves[0])){
                    revertcolor(possiblemoves);
                    // reset order counter
                    orderCounter = 1;
                    document.getElementById("buttonstart").textContent = "Count " + (orderCounter);
                    return;
                }
                // make sure button is in list of possible moves
                for (var i = 0; i < possiblemoves.length; i++) {
                    if(String(possiblemoves[i]) == button.id){
                        move_flag = 1;
                        break;
                    }
                }
                // if space not in list if possible moves do nothing
                if(move_flag == 0){return;}
                // reset move flag
                move_flag = 0;

                 // check to see if rook move
                if(document.getElementById(String(possiblemoves[0])).textContent == '♖' || document.getElementById(String(possiblemoves[0])).textContent == '♜'){
                    // see if kingside rook is moving
                    if(document.getElementById(String(possiblemoves[0])).textContent == '♖' && button.id == 8){white_kingside = 0;}
                    else if(document.getElementById(String(possiblemoves[0])).textContent == '♖' && button.id == 1){white_queenside = 0;}
                    else if(document.getElementById(String(possiblemoves[0])).textContent == '♜' && button.id == 64){black_kingside = 0;}
                    else if(document.getElementById(String(possiblemoves[0])).textContent == '♜' && button.id == 57){black_queenside = 0;}
                }

                // check to see if king move
                if(document.getElementById(String(possiblemoves[0])).textContent == '♔' || document.getElementById(String(possiblemoves[0])).textContent == '♚'){
                    // move is a kingmove so that color can no longer castle
                    if(document.getElementById(String(possiblemoves[0])).textContent == '♔'){
                        white_kingside = 0;
                        white_queenside = 0;
                    }
                    else{
                        black_kingside = 0;
                        black_queenside = 0;
                    }
                
                    // king is moving 2 spaces so its a castle
                    if(Math.abs(parseInt(button.id) - possiblemoves[0]) == 2){
                        // black kingside
                        if(parseInt(button.id) == 63){
                            document.getElementById(62).textContent = document.getElementById(64).textContent;
                            document.getElementById(64).textContent = '';
                        }
                        // black queenside
                        if(parseInt(button.id) == 59){
                            document.getElementById(60).textContent = document.getElementById(57).textContent;
                            document.getElementById(57).textContent = '';
                        }
                        // white kingside
                        if(parseInt(button.id) == 7){
                            document.getElementById(6).textContent = document.getElementById(8).textContent;
                            document.getElementById(8).textContent = '';
                        }
                        // white queenside
                        if(parseInt(button.id) == 3){
                            document.getElementById(4).textContent = document.getElementById(1).textContent;
                            document.getElementById(1).textContent = '';
                        }
                        castle_flag = 1;
                    }
                }
            
                button.textContent = document.getElementById(String(possiblemoves[0])).textContent;
                document.getElementById(String(possiblemoves[0])).textContent = "";
                //promote any pawns
                pawn_promotion();
                sendMoveToServer(String(possiblemoves[0]) + ' ' + button.id);
                revertcolor(possiblemoves);
                orderCounter = 0;
                // increment turn counter and update display
                turn_flag = turn_flag + 1;
                if(turn_flag > 1){turn_flag = 0;}
                if(turn_flag == 0){document.getElementById("buttonTurn").textContent = "Turn: white";}
                else{document.getElementById("buttonTurn").textContent = "Turn: Black";}
                isKingChecked()
                document.getElementById("check_white").textContent = ("Check w: "+ String(check_flag_white));
                document.getElementById("check_black").textContent = ("Check b: "+ String(check_flag_black));
                
                // Get every legal move
                legal_array = legalMoves()
                //console.log(legal_array)
                if(isCheckmate()){
                    window.alert("Checkmate Game is Over")
                }
                await waitForServer();
            }
    
            orderCounter++;
            document.getElementById("buttonstart").textContent = "Count " + (orderCounter);
            end = performance.now()
            //console.log(String(end-start))
        }
    }

    function isKingChecked(){
        potential_moves_check = [];
        check_flag_white = 0;
        check_flag_black = 0;
        for (let i = 1; i <= 64; i++) {
            if(document.getElementById(String(i)).textContent != ''){
                potential_moves_check = setpossiblemoves(i,document.getElementById(String(i)).textContent,0)
                for (var j = 1; j < potential_moves_check.length; j++) {
                    //console.log('i: ' + String(i) + ' ' + String( document.getElementById(String(i)).textContent) + ' j: '+ String(potential_moves[j]) + ' ' + String( document.getElementById(String(potential_moves[j])).textContent))
                    if(getColor(document.getElementById(String(i)).textContent) == 'black' && document.getElementById(String(potential_moves_check[j])).textContent == '♔'){
                        //console.log(String(document.getElementById(String(i)).textContent) + ' id: ' + String(i) + ' is checking ' + document.getElementById(String(potential_moves_check[j])).textContent + ' id: ' + potential_moves_check[j])
                        //printboard()
                        
                        check_flag_white = 1;
                    }
                    if(getColor(document.getElementById(String(i)).textContent) == 'white' && document.getElementById(String(potential_moves_check[j])).textContent == '♚'){
                        //console.log(String(document.getElementById(String(i)).textContent) + ' id: ' + String(i) + ' is checking ' + document.getElementById(String(potential_moves_check[j])).textContent + ' id: ' + potential_moves_check[j])
                        check_flag_black = 1;
                        //printboard()
                    }         
                }
            }
            
        }
    }

    //function will get called after every move to see if the game is over
    function isCheckmate(){
        for(i = 1; i < legal_array.length;i++){
            if(legal_array[i].length > 0){
                return false;}
        }
        return true;
    }
    function printboard(){
        for(i = 7;i>=0;i--){
            for(j = 8;j>0;j--){
                console.log(String(document.getElementById(String((i*8) + j)).textContent));
            }
            console.log('\n')
        }

    }

    function legalMoves(){
        legal_moves = [];
        legal_temp = [];
        // loop though every square on the board
        for (let i = 1; i <= 64; i++) {
            if(document.getElementById(String(i)).textContent != ''){
                // check to make sure if piece is white then its whites turn and vice versa
                if((getColor(document.getElementById(String(i)).textContent) == 'white' && turn_flag == 0) || (getColor(document.getElementById(String(i)).textContent) == 'black' && turn_flag == 1)){
                    potential_moves = setpossiblemoves(i,document.getElementById(String(i)).textContent,0)
                }
                else{
                    potential_moves = []
                }
                //console.log(String(document.getElementById(String(i)).textContent) + ' ' + String(potential_moves))
                legal_temp = [];
                for (var j = 1; j < potential_moves.length; j++) {
                    tempi = document.getElementById(String(i)).textContent;
                    tempj = document.getElementById(String(potential_moves[j])).textContent;

                    document.getElementById(String(potential_moves[j])).textContent = tempi;
                    document.getElementById(String(i)).textContent = '';

                    isKingChecked();
                    if(!(turn_flag == 0 && check_flag_white == 1) && !(turn_flag == 1 && check_flag_black == 1) ){
                        legal_temp.push(potential_moves[j]);
                    }
                    document.getElementById(String(potential_moves[j])).textContent = tempj;
                    document.getElementById(String(i)).textContent = tempi;
       
                }
                legal_moves[i]=legal_temp
                
            }
            else{
                legal_moves[i] = []
            }
            
        }


        // look for castling
        // black kingside
        if((black_kingside == 1) && (document.getElementById(62).textContent == '' && document.getElementById(63).textContent == '' && document.getElementById(64).textContent == '♜')){
            // move king to both squares and see if its in check
            document.getElementById(62).textContent = '♚' 
            document.getElementById(63).textContent = '♚'
            isKingChecked()
            if(check_flag_black == 0){
                legal_moves[61].push(63)
            }
            document.getElementById(62).textContent = ''
            document.getElementById(63).textContent = ''            
        }
        // black queenside
        if((black_queenside == 1) && (document.getElementById(59).textContent == '' && document.getElementById(60).textContent == '' && document.getElementById(57).textContent == '♜')){
            // move king to both squares and see if its in check
            document.getElementById(59).textContent = '♚' 
            document.getElementById(60).textContent = '♚'
            isKingChecked()
            if(check_flag_black == 0){
                legal_moves[61].push(59)
            }
            document.getElementById(59).textContent = ''
            document.getElementById(60).textContent = ''
        }
        // white kingside
        if((white_kingside == 1) && (document.getElementById(6).textContent == '' && document.getElementById(7).textContent == '' && document.getElementById(8).textContent == '♖')){
            // move king to both squares and see if its in check
            document.getElementById(6).textContent = '♔' 
            document.getElementById(7).textContent = '♔'
            isKingChecked()
            if(check_flag_white == 0){
                legal_moves[5].push(7)
            }
            document.getElementById(6).textContent = ''
            document.getElementById(7).textContent = ''
        }
        // white queenside
        if((white_queenside) == 1 && (document.getElementById(3).textContent == '' && document.getElementById(4).textContent == ''&& document.getElementById(1).textContent == '♖')){
            document.getElementById(3).textContent = '♔' 
            document.getElementById(4).textContent = '♔'
            isKingChecked()
            if(check_flag_white == 0){
                legal_moves[5].push(3)
            }
            document.getElementById(3).textContent = ''
            document.getElementById(4).textContent = ''
        }

        return legal_moves;
    }

    function pawn_promotion(){

        var whiteDropdown = document.getElementById("PromotionWhite");
        var blackDropdown = document.getElementById("PromotionBlack");

        var selectedWhiteValue = whiteDropdown.options[whiteDropdown.selectedIndex].value;
        var selectedBlackValue = blackDropdown.options[blackDropdown.selectedIndex].value;

        edges = [1,2,3,4,5,6,7,8,57,58,59,60,61,62,63,64]
        for(i=0;i<edges.length;i++){
            if(document.getElementById(edges[i]).textContent == '♙' || document.getElementById(edges[i]).textContent == '♟'){
                if(getColor(document.getElementById(edges[i]).textContent) == 'white'){
                    document.getElementById(edges[i]).textContent = selectedWhiteValue;
                    promoted_to = selectedWhiteValue;
                }
                else{
                    document.getElementById(edges[i]).textContent = selectedBlackValue;
                    promoted_to = selectedBlackValue;
                }
                pawn_promoted_flag = 1;
            }
        }
    }

    function getColor(piece){
        color = ''
        if (piece == '♙' || piece == '♖' || piece == '♘' || piece == '♗' || piece == '♕'  || piece == '♔'){
            color = 'white';
        }
        else{color = 'black';}
        return color;
    }

    function revertcolor(moves) {

        for (var i = 0; i < moves.length; i++) {
            if ((moves[i] >= 1 && moves[i] <= 8) || (moves[i] >= 17 && moves[i] <= 24)|| (moves[i] >= 33 && moves[i] <= 40)|| (moves[i] >= 49 && moves[i] <= 56)) {
                if (moves[i] % 2 == 0) {
                    document.getElementById(String(moves[i])).style.backgroundColor = '#eee';
                } else {
                    document.getElementById(String(moves[i])).style.backgroundColor = '#aaa';
                }
            } else {
                if (moves[i] % 2 == 0) {
                    document.getElementById(String(moves[i])).style.backgroundColor = '#aaa';
                } else {
                    document.getElementById(String(moves[i])).style.backgroundColor = '#eee';
                }
            }
        }
    }

    function setpossiblemoves(from,piece, changeColorFlag){
        p_moves = [];

        p_moves.push(from); // add the moving piece to the array

        //check what piece it is and set the moves accordingly
        if((piece == '♙') || (piece == '♟')){setPawnMoves(p_moves,from,piece);}
        else if((piece == '♖') || (piece == '♜')){setRookMoves(p_moves,from,piece);}
        else if((piece == '♗') || (piece == '♝')){setBishopMoves(p_moves,from,piece);}
        else if((piece == '♕') || (piece == '♛')){setQueenMoves(p_moves,from,piece);}
        else if((piece == '♘') || (piece == '♞')){setKnightMoves(p_moves,from,piece);}
        else if((piece == '♔') || (piece == '♚')){setKingMoves(p_moves,from,piece);}
        else{throw new Error('Cannot set possible moves, piece is not a chesspiece');}

        return p_moves;;
    }

    // change the color of all the potential move spaces
    function setMoveColor(array){
        for (var i = 0; i < array.length; i++) {
            document.getElementById(String(array[i])).style.backgroundColor = c_spacetomove;
        }
    }

    function setPawnMoves(possible_moves, from, piece){
        // set dirrection, either up the board or down, so that the possible moves can be multiplied by it
        if (piece == '♙'){dir = 1;}
        else{dir = -1;}
        pieceColor = getColor(piece);

        // if pawn is at the end of the board just return for now
        if((pieceColor == 'black' && (from >= 1 && from <= 8)) || (pieceColor == 'white' && (from >= 57 && from <= 64))){return;}

        // START ADDING POSSIBLE MOVES
        // if space ahead is empty add that move
        if(document.getElementById(String(from+(8*dir))).textContent == ''){
            possible_moves.push(from+(8*dir));
        }

        if(from % 8 !== 0)
        {
            // if there is a piece that can be taken to the right
            if((document.getElementById(String(from+(8*dir) + 1)).textContent !== '') && (pieceColor !== getColor(document.getElementById(String(from+(8*dir) + 1)).textContent))){
                possible_moves.push(from+(8*dir) + 1);
        }
        }
        if(from % 8 !== 1)
        {
            // if there is a piece that can be taken to the left
            if((document.getElementById(String(from+(8*dir) - 1)).textContent !== '') && (pieceColor !== getColor(document.getElementById(String(from+(8*dir) - 1)).textContent))){

                possible_moves.push(from+(8*dir) - 1);
        }
        }
        // if piece is in the first row of either side add the optional 2 space move
        if (((dir == 1 && (from >= 9 && from <= 16)) ||(dir == -1 && (from >= 49 && from <= 66))) && (document.getElementById(String(from+(16*dir))).textContent == '') ){
            if(document.getElementById(String(from+(8*dir))).textContent == ''){
                possible_moves.push(from+(16*dir));
            }
        }

        return possible_moves;

    }

    function setRookMoves(possible_moves, from, piece){
        pieceColor = getColor(piece);
        col = ((from-1)%8)+1;
        row = Math.floor((from-1)/8);

        // START ADDING POSSIBLE MOVES
        // add moves to the right til you hit something
        tempcol = col + 1; // move by 1 to start checking 1 right of the piece
        temprow = row;
        while(tempcol <= 8){
            if(document.getElementById(String(tempcol + (temprow*8))).textContent == ''){
                possible_moves.push(tempcol + (temprow*8));
            }
            else{
                if(getColor(document.getElementById(String(tempcol + (temprow*8))).textContent) !== pieceColor){
                    possible_moves.push(tempcol + (temprow*8));
                }
                break;
            }
            tempcol++;
        }

        // add moves to the left til you hit something
        tempcol = col - 1; // move by 1 to start checking 1 left of the piece
        temprow = row;
        while(tempcol >= 1){
            if(document.getElementById(String(tempcol + (temprow*8))).textContent == ''){
                possible_moves.push(tempcol + (temprow*8));
            }
            // check if piece hit is a different color
            else{
                if(getColor(document.getElementById(String(tempcol + (temprow*8))).textContent) !== pieceColor){
                    possible_moves.push((tempcol + (temprow*8)));
                }
                break;
            }
            tempcol--;
        }

        // add moves up til you hit something
        tempcol = col ;
        temprow = row + 1; // move by 1 to start checking 1 above the piece
        while(temprow <= 7){
            if(document.getElementById(String(tempcol + (temprow*8))).textContent == ''){
                possible_moves.push(tempcol + (temprow*8));
            }
            // check if piece hit is a different color
            else{
                if(getColor(document.getElementById(String(tempcol + (temprow*8))).textContent) !== pieceColor){
                    possible_moves.push((tempcol + (temprow*8)));
                }
                break;
            }
            temprow++;
        }

        // add moves down til you hit something
        tempcol = col ;
        temprow = row - 1; // move by 1 to start checking 1 below the piece
        while(temprow >= 0){
            if(document.getElementById(String(tempcol + (temprow*8))).textContent == ''){
                possible_moves.push(tempcol + (temprow*8));
            }
            // check if piece hit is a different color
            else{
                if(getColor(document.getElementById(String(tempcol + (temprow*8))).textContent) !== pieceColor){
                    possible_moves.push((tempcol + (temprow*8)));
                }
                break;
            }
            temprow--;
        }


        return possible_moves;
    }

    function setBishopMoves(possible_moves, from, piece){
        pieceColor = getColor(piece);
        col = ((from-1)%8)+1;
        row = Math.floor((from-1)/8);

        // START ADDING POSSIBLE MOVES
        // add moves to the top right til you hit something
        tempcol = col + 1; // move by 1 to start checking 1 right of the piece
        temprow = row + 1; // move by 1 to start checking 1 up of the piece
        while(tempcol <= 8 && temprow <= 7){
            if(document.getElementById(String(tempcol + (temprow*8))).textContent == ''){
                possible_moves.push(tempcol + (temprow*8));
            }
            else{
                if(getColor(document.getElementById(String(tempcol + (temprow*8))).textContent) !== pieceColor){
                    possible_moves.push(tempcol + (temprow*8));
                }
                break;
            }
            tempcol++;
            temprow++;
        }

        // add moves to the bottom right til you hit something
        tempcol = col + 1; // move by 1 to start checking 1 right of the piece
        temprow = row - 1; // move by 1 to start checking 1 down of the piece
        while(tempcol <= 8 && temprow >= 0){
            if(document.getElementById(String(tempcol + (temprow*8))).textContent == ''){
                possible_moves.push(tempcol + (temprow*8));
            }
            else{
                if(getColor(document.getElementById(String(tempcol + (temprow*8))).textContent) !== pieceColor){
                    possible_moves.push(tempcol + (temprow*8));
                }
                break;
            }
            tempcol++;
            temprow--;
        }

        // add moves to the bottom left til you hit something
        tempcol = col - 1; // move by 1 to start checking 1 left of the piece
        temprow = row - 1; // move by 1 to start checking 1 down of the piece
        while(tempcol >= 1 && temprow >= 0){
            if(document.getElementById(String(tempcol + (temprow*8))).textContent == ''){
                possible_moves.push(tempcol + (temprow*8));
            }
            else{
                if(getColor(document.getElementById(String(tempcol + (temprow*8))).textContent) !== pieceColor){
                    possible_moves.push(tempcol + (temprow*8));
                }
                break;
            }
            tempcol--;
            temprow--;
        }

        // add moves to the top left til you hit something
        tempcol = col - 1; // move by 1 to start checking 1 left of the piece
        temprow = row + 1; // move by 1 to start checking 1 up of the piece
        while(tempcol >= 1 && temprow <= 7){
            if(document.getElementById(String(tempcol + (temprow*8))).textContent == ''){
                possible_moves.push(tempcol + (temprow*8));
            }
            else{
                if(getColor(document.getElementById(String(tempcol + (temprow*8))).textContent) !== pieceColor){
                    possible_moves.push(tempcol + (temprow*8));
                }
                break;
            }
            tempcol--;
            temprow++;
        }
    }

    function setQueenMoves(possible_moves, from, piece){
        // since the queen can move as both a rook and a bishop can simply call those 2 functions
        setBishopMoves(possible_moves,from,piece);
        setRookMoves(possible_moves,from,piece);
    }

    function setKnightMoves(possible_moves, from, piece){
        pieceColor = getColor(piece);
        col = ((from-1)%8)+1;
        row = Math.floor((from-1)/8);

        // START ADDING POSSIBLE MOVES
        // add all 8 possible moves to array
        movelist = [[col+1,row+2],[col-1,row+2],[col+1,row-2],[col-1,row-2],[col+2,row+1],[col+2,row-1],[col-2,row+1],[col-2,row-1]];
        // check to see what moves of the possible ones are valid
        for(var i=0;i<movelist.length;i++){
            if(movelist[i][0] >= 1 && movelist[i][0] <= 8 && movelist[i][1] >= 0 && movelist[i][1] <= 7){ // if the move is within bounds
                if(document.getElementById(String(movelist[i][0] + (movelist[i][1]*8))).textContent == ''){
                    possible_moves.push(movelist[i][0] + (movelist[i][1]*8));
                }
                else{
                    if(getColor(document.getElementById(String(movelist[i][0] + (movelist[i][1]*8))).textContent) !== pieceColor){
                        possible_moves.push(movelist[i][0] + (movelist[i][1]*8));
                    }   
                }
            }
            else{;} // move is not in bounds so do nothing
        }
    }

    function setKingMoves(possible_moves, from, piece){
        pieceColor = getColor(piece);
        col = ((from-1)%8)+1;
        row = Math.floor((from-1)/8);

        // START ADDING POSSIBLE MOVES
        // add all 8 possible moves to array
        movelist = [[col,row+1],[col+1,row+1],[col+1,row],[col+1,row-1],[col,row-1],[col-1,row-1],[col-1,row],[col-1,row+1]];
        // check to see what moves of the possible ones are valid
        for(var i=0;i<movelist.length;i++){
            if(movelist[i][0] >= 1 && movelist[i][0] <= 8 && movelist[i][1] >= 0 && movelist[i][1] <= 7){ // if the move is within bounds
                if(document.getElementById(String(movelist[i][0] + (movelist[i][1]*8))).textContent == ''){
                    possible_moves.push(movelist[i][0] + (movelist[i][1]*8));
                }
                else{
                    if(getColor(document.getElementById(String(movelist[i][0] + (movelist[i][1]*8))).textContent) !== pieceColor){
                        possible_moves.push(movelist[i][0] + (movelist[i][1]*8));
                    }   
                }
            }
            else{;} // move is not in bounds so do nothing
        }
    }


    function sendMoveToServer(message) {
        
        // Make an asynchronous request to the server
        fetch('/sendmove', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message: translate_toUCI(message) }),
        })
        .then(response => response.text())
        .then(data => {
            console.log('Server response:', data);
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    async function ReceiveMoveFromServer() {
        await fetch('/receivemove')
        .then(response => response.json())
        .then(data => {
            console.log('Server response:', data);
            response = data['message'];
        })
        .catch(error => {
            console.error('Error fetching status:', error);
        });
        return response
    }

    function waitForServer(){
        reply = ''
        console.log("waiting for server")
        var intervalId = window.setInterval(async function(){
        // call your function here
        reply = await ReceiveMoveFromServer()
        console.log("response inside wait ",reply)
        if (reply !== '' && typeof reply !== 'undefined'){
            clearInterval(intervalId)
            UCI_reply = translate_fromUCI(reply)
            reply_list = UCI_reply.split(' ')
            from = reply_list[0]
            to = reply_list[1]
            //console.log(from)
            //console.log(to)

            // check to see if king move
            if(document.getElementById(from).textContent == '♔' || document.getElementById(from).textContent == '♚'){
                // king is moving 2 spaces then its a castle
                if(Math.abs(parseInt(from) - parseInt(to)) == 2){
                    // black kingside
                    if(parseInt(to) == 63){
                        document.getElementById(62).textContent = document.getElementById(64).textContent;
                        document.getElementById(64).textContent = '';
                    }
                    // black queenside
                    if(parseInt(to) == 59){
                        document.getElementById(60).textContent = document.getElementById(57).textContent;
                        document.getElementById(57).textContent = '';
                    }
                    // white kingside
                    if(parseInt(to) == 7){
                        document.getElementById(6).textContent = document.getElementById(8).textContent;
                        document.getElementById(8).textContent = '';
                    }
                    // white queenside
                    if(parseInt(to) == 3){
                        document.getElementById(4).textContent = document.getElementById(1).textContent;
                        document.getElementById(1).textContent = '';
                    }
               }
            }

            document.getElementById(to).textContent = document.getElementById(from).textContent;
            document.getElementById(from).textContent = ''


            // increment turn counter and update display
            orderCounter = 1
            // increment turn counter and update display
            turn_flag = turn_flag + 1;
            if(turn_flag > 1){turn_flag = 0;}
            if(turn_flag == 0){document.getElementById("buttonTurn").textContent = "Turn: white";}
            else{document.getElementById("buttonTurn").textContent = "Turn: Black";}
            isKingChecked()
            document.getElementById("check_white").textContent = ("Check w: "+ String(check_flag_white));
            document.getElementById("check_black").textContent = ("Check b: "+ String(check_flag_black));
            // Get every legal move
            legal_array = legalMoves()
            //console.log(legal_array)
            if(isCheckmate()){
                window.alert("Checkmate Game is Over")
            }
            }
        }, 500);       
    }

    // convert move from webpage syntax to UCI
    // take in move in "12 28" format into 'd2d4 ' format
    function translate_toUCI(move) {
        UCImove = ''
        
        if(castle_flag == 1){
            if(move == '5 7'){UCImove = 'e1h1 ';}
            else if(move == '5 3'){UCImove = 'e1a1 '}
            else if(move == '61 63'){UCImove = 'e8h8 '}
            else if(move == '61 59'){UCImove = 'e8a8 '} 
            castle_flag = 0;
            return UCImove;
        }
        
        move_list = move.split(' ')
        from = move_list[0]
        to = move_list[1]

        from_row = Math.floor((from-1) / 8) + 1
        from_col = (from-1) % 8

        to_row = Math.floor((to-1) / 8) + 1
        to_col = (to-1) % 8

        s1 = String.fromCharCode(from_col + 97)
        s2 = from_row
        s3 = String.fromCharCode(to_col + 97)
        s4 = to_row

        if(pawn_promoted_flag == 1){
            if((promoted_to == '♖') || (promoted_to == '♜')){s5='r';}
            else if((promoted_to == '♗') || (promoted_to == '♝')){s5='b';}
            else if((promoted_to == '♕') || (promoted_to == '♛')){s5='q';}
            else if((promoted_to == '♘') || (promoted_to == '♞')){s5='k';}
            promoted_to = '';
            pawn_promoted_flag = 0;        
        }
        else {s5 = ' ';}

        UCImove = s1 + s2 + s3 + s4 + s5

        //console.log(UCImove)

        return UCImove
    }

    // convert move from UCI to Webpage Syntax
    // takes in 'd2d4' and outputs '12 28'
    function translate_fromUCI(UCImove) {
        move = ''
        // remove spaces
        UCImove = UCImove.replace(/\s/g, '');


        if(UCImove == 'e1h1'){move = '5 7';return move;}
        else if(UCImove == 'e1a1'){move = '5 3';return move;}
        else if(UCImove == 'e8h8'){move = '61 63';return move;}
        else if(UCImove == 'e8a8'){move = '61 59';return move;}

        UCImove_list = UCImove.split('')   

        from_row = UCImove_list[1]
        from_col = UCImove_list[0]

        to_row = UCImove_list[3]
        to_col = UCImove_list[2]

        from_col = from_col.charCodeAt(0) - 96;
        to_col =  to_col.charCodeAt(0) - 96;

        from_row = (from_row - 1) * 8
        to_row = (to_row - 1) * 8

        from = from_col + from_row
        to = to_col + to_row

        move = from + ' ' + to
        //console.log(move)

        if(UCImove.length == 5){
            promation_type = UCImove_list[4];
            from_color = getColor(document.getElementById(from))
            if(from_color == 'white' && promation_type == 'q'){document.getElementById("PromotionWhite").value = '♕';}
            else if(from_color == 'black' && promation_type == 'q'){document.getElementById("PromotionWhite").value = '♛';}
        }

        return move
    }


</script>

</body>
</html>
